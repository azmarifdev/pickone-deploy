version: '3.8'

services:
    pickone-client:
        container_name: pickone-client
        build:
            context: ./pickone-client
            dockerfile: Dockerfile
        ports:
            - '4000:4000'
        env_file:
            - .env
        volumes:
            - ./pickone-client:/client
            - /client/node_modules
            - /client/.next
        networks:
            - pickone-network
        depends_on:
            - pickone-backend
        restart: unless-stopped

    pickone-backend:
        container_name: pickone-backend
        build:
            context: ./pickone-server
            dockerfile: Dockerfile
        ports:
            - '5000:5000'
        volumes:
            - ./pickone-server:/app
            - /app/node_modules
            - /app/dist
            - server-tmp:/tmp
            - ./server-tmp:/app/server-tmp
        env_file:
            - .env
        networks:
            - pickone-network
        restart: unless-stopped

    pickone-admin:
        container_name: pickone-admin
        build:
            context: ./pickone-admin
            dockerfile: Dockerfile
        ports:
            - '3000:3000'
        env_file:
            - .env
        volumes:
            - ./pickone-admin:/src
            - /src/node_modules
            - /src/.next
        networks:
            - pickone-network
        depends_on:
            - pickone-backend
        restart: unless-stopped

    mongodb:
        image: mongo:latest
        container_name: pickone-mongodb
        ports:
            - '27017:27017'
        volumes:
            - mongo-data:/data/db
        networks:
            - pickone-network
        environment:
            - MONGO_INITDB_ROOT_USERNAME=${DB_USERNAME}
            - MONGO_INITDB_ROOT_PASSWORD=${DB_PASSWORD}
            - MONGO_INITDB_DATABASE=${DB_NAME}
        restart: unless-stopped

    nginx:
        image: nginx:latest
        container_name: pickone-nginx
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf
            - server-tmp:/tmp
            - ./ssl-certs:/etc/nginx/ssl
            - ./certbot/conf:/etc/letsencrypt
            - ./certbot/www:/var/www/certbot
        depends_on:
            - pickone-backend
            - pickone-client
            - pickone-admin
        networks:
            - pickone-network
        restart: unless-stopped

    certbot:
        image: certbot/certbot:latest
        container_name: pickone-certbot
        volumes:
            - ./certbot/conf:/etc/letsencrypt
            - ./certbot/www:/var/www/certbot
        command: certonly --webroot --webroot-path=/var/www/certbot --email admin@azmarif.dev --agree-tos --no-eff-email -d admin.azmarif.dev -d client.azmarif.dev -d server.azmarif.dev
        depends_on:
            - nginx
        networks:
            - pickone-network

volumes:
    mongo-data:
        driver: local
    server-tmp:
        driver: local

networks:
    pickone-network:
        driver: bridge
